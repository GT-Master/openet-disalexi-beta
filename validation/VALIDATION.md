# GEE DisALEXI Conversion Validation

## Initial Intermediate Function Validation

The primary validation that has been done between the Python and GEE DisALEXI codes is to compare the outputs from all of the intermediate functions within TSEB_usda.py and TSEB_utils_usda.py for a single image, at two fixed points, for a small subset of air temperatures.  For this limited range of test inputs, all of the functions are generating nearly identical values (with a minimum tolerance of 0.000001).

### Test Values

The majority of the values in the test functions were generated by running the Python DisALEXI code for fixed points and air temperatures and capturing the input and output to each of main and intermediate functions.

### Validation Assets

The primary source of validation between the Python and GEE DisALEXI codes so far has been the provided test data set for a small area in eastern Nebraska from Landsat image LC08_028031_20140708 on 2014-07-08 (DOY 189).

The validation dataset did not include a Landsat MTL file, so the [AWS LC80280312014189LGN00 MTL](https://landsat-pds.s3.amazonaws.com/L8/028/031/LC80280312014189LGN00/LC80280312014189LGN00_MTL.txt) was used.  The following line needed to be added to the MTL file in order to run the Python code:
```
LANDSAT_PRODUCT_ID = "LC80280312014189LGN00"
```

The Mask file needed to be renamed from "LC80280312014141LGN00_Mask.tiff" to "LC80280312014341LGN00_Mask.tiff" (notice the DOY 341).

Before ingesting into GEE, the validation assets were converted from 16 bit integers to 64bit floats and then scaled to the appropriate range/units (e.g. LST * 0.01 + 273.15).  The details of this conversion can be found in the "validation/ingest_validation_assets.py" script.

### Test Points

The test points used for the validation are the AmeriFlux tower locations.  There are three sites (US-NE1, US-NE2, and US-NE3) within the validation scene that are all located within ~1 mile of each other.  The coordinates for the towers were retrieved from http://sites.ameriflux.lbl.gov/US-NE1/.  The coordinates were converted to WGS84 Zone14N (EPSG:32614), then snapped to the closest Landsat cell centroid, and then projected back to WGS84 (EPSG:4326).

The following GEE playground link should demonstrate the conversion process:
https://code.earthengine.google.com/3686cd4bce60c6fdc81acbfaee22dd1f

#### US-NE1

WGS84 Zone 14N coordinates: 711690, 4560150
WGS84 coordinates: -96.47672812080845, 41.16506126041818
Test image row/col: ?, ?
IDL Tile: 29, Tile index: 202437

#### US-NE2

WGS84 Zone 14N coordinates: 712260, 4560150
WGS84 coordinates: -96.46994024736414, 41.16491226772292
Test image row/col: ?, ?
IDL Tile: 29, Tile index: 202456

#### US-NE3

WGS84 Zone 14N coordinates: 714750, 4561860
WGS84 coordinates: -96.43968912903934, 41.17964494123755
Test image row/col: ?, ?
IDL Tile: 29, Tile index: 31539

#### Test Air Temperatures

Test values were generated for the following air temperature values: 275, 280, 285, 290, 295.

### Python Values

Values were extracted from the Python code by calling the following in the main function of pydisalexi_usda.py instead of the runDisALEXI parallel calls (using coordinates for the high NDVI test point):
```
dd.runDisALEXI(ROW, COL, ALEXIgeodict, 0)
```

### Python Code Changes

The following changes were made to the Python DisALEXI code in order to ensure absolute agreement in the intermediate calculations between the two models.
+ The latitude array was flipped vertically in the Python code
+ All arrays are read in as 64 bit floats
+ The lat/lon arrays are saved as 64 bit floats also
